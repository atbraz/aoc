# Advent of Code 2022 - Justfile (OCaml)
# Usage:
#   just --list              - Show all available commands
#   just install-toolchain   - Install OCaml, opam, and dune
#   just run 1               - Build and run day 1 with input file
#   just test 1              - Build and run day 1 with sample input
#   just build 1             - Build day 1
#   just new 5               - Create new day 5 solution
#   just clean               - Clean all build artifacts

YEAR := "2022"

# Default - show available commands
default:
    @just --list

# Build a specific day
[group('build')]
build day:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Building day {{day}}..."
    dune build {{day}}/main.exe

# Build all days
[group('build')]
build-all:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Building all days..."
    dune build

# Build and run a specific day with input file
[group('run')]
run day:
    #!/usr/bin/env bash
    set -euo pipefail
    just build {{day}}
    echo "Running day {{day}} with input..."
    echo ""
    dune exec aoc-{{YEAR + "-" + day}} {{day}}/input

# Build and run a specific day with sample input
[group('test')]
test day sample="sample":
    #!/usr/bin/env bash
    set -euo pipefail
    just build {{day}}
    echo "Running day {{day}} with {{sample}}..."
    echo ""
    dune exec aoc-{{YEAR + "-" + day}} {{day}}/{{sample}}

# Run tests for a specific day (if they exist)
[group('test')]
test-unit day:
    dune runtest {{day}}

# Create a new day solution
[group('setup')]
new day:
    #!/usr/bin/env bash
    set -euo pipefail

    if [ -d "{{day}}" ]; then
        echo "Error: Day {{day}} already exists!"
        exit 1
    fi

    echo "Creating directory for day {{day}}..."
    mkdir -p "{{day}}"

    # Create dune file
    echo "Creating dune file..."
    printf '%s\n' \
      '(executable' \
      ' (name main)' \
      ' (public_name aoc-{{YEAR + "-" + day}})' \
      ' (package aoc-{{YEAR}})' \
      ' (libraries aoc-common-ocaml))' \
      > "{{day}}/dune"

    # Create main.ml template
    echo "Creating main.ml..."
    printf '%s\n' \
      'open Aoc_common_ocaml' \
      '' \
      'let parse_input filename =' \
      '  let lines = In_channel.with_open_text filename In_channel.input_lines in' \
      '  lines' \
      '' \
      'let part1 lines =' \
      '  (* TODO: Implement part 1 *)' \
      '  ignore lines;' \
      '  0' \
      '' \
      'let part2 lines =' \
      '  (* TODO: Implement part 2 *)' \
      '  ignore lines;' \
      '  0' \
      '' \
      'let () =' \
      '  if Array.length Sys.argv < 2 then (' \
      '    Printf.eprintf "Usage: %s <input_file>\n" Sys.argv.(0);' \
      '    exit 1' \
      '  );' \
      '' \
      '  let filename = Sys.argv.(1) in' \
      '  let lines = parse_input filename in' \
      '' \
      '  Printf.printf "Part 1: %d\n" (part1 lines);' \
      '  Printf.printf "Part 2: %d\n" (part2 lines)' \
      > "{{day}}/main.ml"

    # Create empty input files
    echo "Creating input files..."
    touch "{{day}}/input"
    touch "{{day}}/sample"

    echo ""
    echo "Successfully created day {{day}}!"
    echo ""
    echo "Next steps:"
    echo "  1. Add your puzzle input to {{day}}/input"
    echo "  2. Add sample input to {{day}}/sample"
    echo "  3. Implement your solution in {{day}}/main.ml"
    echo "  4. Test with: just test {{day}}"
    echo "  5. Run with: just run {{day}}"

# Clean build artifacts
[group('clean')]
clean:
    dune clean

# Format OCaml code
[group('format')]
fmt day="":
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -n "{{day}}" ]; then
        echo "Formatting day {{day}}..."
        dune fmt {{day}}
    else
        echo "Formatting all OCaml files..."
        dune fmt
    fi

# Update OCaml dependencies
[group('update')]
update:
    @echo "Updating OCaml dependencies..."
    opam update
    opam upgrade
    @echo ""
    @echo "Dependencies updated"

# Update OCaml toolchain
[group('update')]
update-toolchain:
    @echo "Updating OCaml toolchain..."
    opam update
    opam switch list-available
    @echo ""
    @ocaml --version
    @dune --version

# Install OCaml toolchain if not present
[group('setup')]
install-toolchain:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "Checking OCaml toolchain installation..."
    echo ""

    # Detect OS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        PKG_MANAGER="brew"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v apt-get &> /dev/null; then
            PKG_MANAGER="apt"
        elif command -v dnf &> /dev/null; then
            PKG_MANAGER="dnf"
        elif command -v pacman &> /dev/null; then
            PKG_MANAGER="pacman"
        else
            echo "Error: Unsupported package manager"
            exit 1
        fi
    else
        echo "Error: Unsupported OS"
        exit 1
    fi

    # Install opam if not present
    if ! command -v opam &> /dev/null; then
        echo "Installing opam..."
        case $PKG_MANAGER in
            brew)
                brew install opam
                ;;
            apt)
                sudo apt-get update
                sudo apt-get install -y opam
                ;;
            dnf)
                sudo dnf install -y opam
                ;;
            pacman)
                sudo pacman -S --noconfirm opam
                ;;
        esac
    else
        echo "✓ opam already installed"
    fi

    # Initialize opam if needed
    if [ ! -d "$HOME/.opam" ]; then
        echo "Initializing opam..."
        opam init -y
        eval $(opam env)
    else
        echo "✓ opam already initialized"
    fi

    # Install OCaml if needed
    if ! command -v ocaml &> /dev/null; then
        echo "Installing OCaml 5.3.0..."
        opam switch create 5.3.0 -y
        eval $(opam env)
    else
        echo "✓ OCaml already installed ($(ocaml --version | head -n1))"
    fi

    # Install dune if not present
    if ! command -v dune &> /dev/null; then
        echo "Installing dune..."
        opam install dune -y
        eval $(opam env)
    else
        echo "✓ dune already installed ($(dune --version))"
    fi

    echo ""
    echo "OCaml toolchain setup complete!"
    echo ""
    echo "Versions:"
    echo "  opam:  $(opam --version)"
    echo "  OCaml: $(ocaml --version | head -n1)"
    echo "  dune:  $(dune --version)"
    echo ""
    echo "Don't forget to run: eval \$(opam env)"
