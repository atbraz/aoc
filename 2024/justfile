# Advent of Code 2024 - Justfile (C++)
# Usage:
#   just --list              - Show all available commands
#   just install-toolchain   - Install C++ compiler (g++ or clang++)
#   just build 1             - Compile day 1
#   just run 1               - Compile and run day 1 with input file
#   just test 1              - Compile and run day 1 tests with assertions
#   just run-sample 1        - Compile and run day 1 with sample input (no assertions)
#   just new 5               - Create new day 5 solution
#   just clean               - Remove all compiled binaries
#   just clean 1             - Remove compiled binary for day 1

# Auto-detect compiler based on platform
# Prefer Homebrew-installed clang on macOS for better standards support
CXX := if os() == "macos" {
    if path_exists("/opt/homebrew/opt/llvm/bin/clang++") == "true" {
        "/opt/homebrew/opt/llvm/bin/clang++"
    } else {
        "clang++"
    }
} else if `command -v g++ >/dev/null 2>&1 && echo 1 || echo 0` == "1" {
    "g++"
} else {
    "clang++"
}

# Auto-detect best C++ standard
# Modern compilers (Clang 17+, GCC 13+, Apple Clang 17+) support C++23
CXXSTD := if os() == "macos" { "c++23" } else { "c++17" }

# Platform-specific optimization flags
OPTFLAGS := if os() == "macos" {
    if arch() == "aarch64" {
        "-O2 -mcpu=apple-m1"
    } else {
        "-O2 -march=native"
    }
} else {
    "-O2 -march=native"
}

CXXFLAGS := "-std=" + CXXSTD + " -Wall -Wextra " + OPTFLAGS
DAYS := "1 2 3 4 5"

# Default - show available commands
default:
    @just --list

# Show detected compiler and build configuration
[group('info')]
info:
    #!/usr/bin/env bash
    echo -e "\033[0;36m=== Build Configuration ===\033[0m"
    echo "OS:           $(uname -s)"
    echo "Architecture: $(uname -m)"
    echo "Compiler:     {{CXX}}"
    echo "C++ Standard: {{CXXSTD}}"
    echo "Flags:        {{CXXFLAGS}}"
    echo ""
    echo -e "\033[0;36m=== Compiler Version ===\033[0m"
    {{CXX}} --version

# Compile a specific day
[group('build')]
build day:
    #!/usr/bin/env bash
    set -euo pipefail
    echo -e "\033[0;32mCompiling day {{day}}...\033[0m"
    mkdir -p build/{{day}}

    # Detect if day uses common library
    COMMON_FILES=""
    if grep -q "#include.*common/" "{{day}}/main.cpp" 2>/dev/null || grep -q "#include.*common/" "{{day}}/solution.cpp" 2>/dev/null; then
        COMMON_FILES="common/parse_input.cpp"
    fi

    # Check if solution.cpp exists (multi-file structure)
    if [ -f "{{day}}/solution.cpp" ]; then
        {{CXX}} {{CXXFLAGS}} -I{{day}} {{day}}/main.cpp {{day}}/solution.cpp $COMMON_FILES -o build/{{day}}/main
    else
        {{CXX}} {{CXXFLAGS}} {{day}}/main.cpp $COMMON_FILES -o build/{{day}}/main
    fi

# Compile all days
[group('build')]
build-all:
    #!/usr/bin/env bash
    set -euo pipefail
    for day in {{DAYS}}; do
        echo -e "\033[0;32mCompiling day $day...\033[0m"
        mkdir -p build/$day

        # Detect if day uses common library
        COMMON_FILES=""
        if grep -q "#include.*common/" "$day/main.cpp" 2>/dev/null || grep -q "#include.*common/" "$day/solution.cpp" 2>/dev/null; then
            COMMON_FILES="common/parse_input.cpp"
        fi

        if [ -f "$day/solution.cpp" ]; then
            {{CXX}} {{CXXFLAGS}} -I$day $day/main.cpp $day/solution.cpp $COMMON_FILES -o build/$day/main
        else
            {{CXX}} {{CXXFLAGS}} $day/main.cpp $COMMON_FILES -o build/$day/main
        fi
    done

# Compile and run a specific day with input file
[group('run')]
run day:
    #!/usr/bin/env bash
    set -euo pipefail
    just build {{day}}
    echo -e "\033[0;32mRunning day {{day}} with input...\033[0m"
    echo ""
    echo "{{day}}/input" | ./build/{{day}}/main

# Compile and run tests with assertions
[group('test')]
test day:
    #!/usr/bin/env bash
    set -euo pipefail
    just build {{day}}
    echo -e "\033[0;32mRunning tests for day {{day}}...\033[0m"
    echo ""
    ./build/{{day}}/main --test

# Compile and run a specific day with sample input (without assertions)
[group('run')]
run-sample day sample="sample_1":
    #!/usr/bin/env bash
    set -euo pipefail
    just build {{day}}
    echo -e "\033[0;32mRunning day {{day}} with {{sample}}...\033[0m"
    echo ""
    echo "{{day}}/{{sample}}" | ./build/{{day}}/main

# Create a new day solution
[group('setup')]
new day:
    #!/usr/bin/env bash
    set -euo pipefail

    if [ -d "{{day}}" ]; then
        echo "Error: Day {{day}} already exists!"
        exit 1
    fi

    echo "Creating directory for day {{day}}..."
    mkdir -p "{{day}}"

    # Copy template files
    TEMPLATE_DIR="./template"

    # Copy solution.h and solution.cpp directly (no placeholders)
    cp "$TEMPLATE_DIR/solution.h" "{{day}}/solution.h"
    cp "$TEMPLATE_DIR/solution.cpp" "{{day}}/solution.cpp"

    # Copy main.cpp and replace <DAY> placeholder
    sed "s/<DAY>/{{day}}/g" "$TEMPLATE_DIR/main.cpp" > "{{day}}/main.cpp"

    # Create empty input files
    echo "Creating input files..."
    touch "{{day}}/input"
    touch "{{day}}/sample_1"

    # Create a simple justfile by copying from day 1 template
    if [ -f "1/justfile" ]; then
        cp "1/justfile" "{{day}}/justfile"
        perl '-pi' '-e' "s/DAY := \"1\"/DAY := \"{{day}}\"/g" "{{day}}/justfile"
        perl '-pi' '-e' "s/# Day 1/# Day {{day}}/g" "{{day}}/justfile"
    fi

    echo ""
    echo "✓ Successfully created day {{day}}!"
    echo ""
    echo "Next steps:"
    echo "  1. Add your puzzle input to {{day}}/input"
    echo "  2. Add sample input to {{day}}/sample_1"
    echo "  3. Implement your solution in {{day}}/solution.cpp"
    echo "  4. Update expected test values in {{day}}/main.cpp (search for TODO)"
    echo "  5. Run tests: just test {{day}}"
    echo "  6. Run with input: just run {{day}}"

# Clean all compiled binaries
[group('clean')]
clean day="":
    #!/usr/bin/env bash
    set -euo pipefail
    if [ -n "{{day}}" ]; then
        echo -e "\033[0;33mCleaning day {{day}}...\033[0m"
        rm -rf build/{{day}}
    else
        echo -e "\033[0;33mCleaning all compiled binaries...\033[0m"
        rm -rf build
    fi

# Update C++ toolchain
[group('update')]
update:
    #!/usr/bin/env bash
    echo -e "\033[0;36mChecking for toolchain updates...\033[0m"
    if [[ "{{os()}}" == "macos" ]]; then
        echo "On macOS, clang++ is provided by Xcode Command Line Tools."
        echo "To update, run: softwareupdate --list"
        echo ""
        echo "Current version:"
        {{CXX}} --version
    elif command -v apt-get >/dev/null 2>&1; then
        echo "Updating via apt-get..."
        sudo apt-get update && sudo apt-get upgrade -y g++ || true
    elif command -v brew >/dev/null 2>&1; then
        echo "Updating via Homebrew..."
        brew update && brew upgrade gcc || true
    else
        echo "No package manager detected. Please update manually."
    fi

# Install C++ toolchain if not present
[group('setup')]
install-toolchain:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "Checking C++ toolchain installation..."
    echo ""

    # Detect OS
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS - check for Xcode Command Line Tools
        if ! command -v clang++ &> /dev/null; then
            echo "Installing Xcode Command Line Tools..."
            xcode-select --install
            echo ""
            echo "Please complete the installation in the dialog that appeared,"
            echo "then run this command again."
            exit 1
        else
            echo "✓ clang++ already installed (via Xcode Command Line Tools)"
        fi
        COMPILER="clang++"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux - install g++
        if ! command -v g++ &> /dev/null; then
            echo "Installing g++..."
            if command -v apt-get &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y build-essential g++
            elif command -v dnf &> /dev/null; then
                sudo dnf install -y gcc-c++
            elif command -v pacman &> /dev/null; then
                sudo pacman -S --noconfirm gcc
            else
                echo "Error: Unsupported package manager"
                echo "Please install g++ manually"
                exit 1
            fi
            echo "✓ g++ installed"
        else
            echo "✓ g++ already installed"
        fi
        COMPILER="g++"
    else
        echo "Error: Unsupported OS"
        exit 1
    fi

    echo ""
    echo "C++ toolchain setup complete!"
    echo ""
    echo "Compiler version:"
    $COMPILER --version | head -n1
    echo ""
    echo "Testing C++17 support..."
    echo 'int main() { auto x = 42; return 0; }' | $COMPILER -std=c++17 -x c++ - -o /tmp/test_cpp17 && echo "✓ C++17 supported" && rm /tmp/test_cpp17
