# Advent of Code 2023 - Justfile (Rust)
# Usage:
#   just --list              - Show all available commands
#   just install-toolchain   - Install Rust via rustup and cargo-nextest
#   just run 8               - Run day 8 with input file (part 1)
#   just run 8 2             - Run day 8 with input file (part 2)
#   just test 8              - Run day 8 with sample input (part 1)
#   just test 8 2 sample_2   - Run day 8 with sample_2 (part 2)
#   just new 11              - Create new day 11 solution
#   just clean               - Clean all build artifacts

YEAR := "2023"

# Default - show available commands
default:
    @just --list

# Run a specific day with input file
[group('run')]
run day part="1" input="input":
    #!/usr/bin/env bash
    set -euo pipefail
    cd {{day}}
    echo "Running day {{day}} part {{part}} with {{input}}..."
    cargo run --quiet -- {{part}} {{input}}

# Run a specific day with sample input
[group('test')]
test day part="1" sample="sample_1":
    #!/usr/bin/env bash
    set -euo pipefail
    cd {{day}}
    echo "Running day {{day}} part {{part}} with {{sample}}..."
    cargo run --quiet -- {{part}} {{sample}}

# Build a specific day
[group('build')]
build day:
    cargo build --package aoc-{{YEAR}}-{{day}}

# Build a specific day (release mode)
[group('build')]
build-release day:
    cargo build --package aoc-{{YEAR}}-{{day}} --release

# Run tests for a specific day
[group('test')]
test-unit day:
    cargo nextest run --package aoc-{{YEAR}}-{{day}}

# Run clippy for a specific day
[group('check')]
check day:
    cargo clippy --package aoc-{{YEAR}}-{{day}} -- -D warnings

# Create a new day solution
[group('setup')]
new day:
    #!/usr/bin/env bash
    set -euo pipefail

    PKG_NAME="aoc-{{YEAR}}-{{day}}"
    DAY_DIR="{{day}}"

    if [ -d "$DAY_DIR" ]; then
        echo "Error: Directory $DAY_DIR already exists"
        exit 1
    fi

    echo "Creating new AOC {{YEAR}} day {{day}} package..."

    # Use cargo to create the package
    cargo new "$DAY_DIR" --name "$PKG_NAME" --vcs none

    # Add dependency using cargo
    cd "$DAY_DIR"
    cargo add aoc-common-rust --path ../../common/rust
    cd ..

    # Copy all template files, replacing placeholders
    TEMPLATE_DIR="../common/rust/template/src"

    if [ -d "$TEMPLATE_DIR" ]; then
        for file in "$TEMPLATE_DIR"/*; do
            if [ -f "$file" ]; then
                filename=$(basename "$file")
                sed -e "s/<YEAR>/{{YEAR}}/g" -e "s/<DAY>/{{day}}/g" "$file" > "$DAY_DIR/src/$filename"
            fi
        done
    fi

    # Add to workspace
    CARGO_TOML="../Cargo.toml"
    if ! grep -q "\"{{YEAR}}/$DAY_DIR\"" "$CARGO_TOML"; then
        # Use a more robust sed approach
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/members = \[/members = [\"{{YEAR}}\/$DAY_DIR\", /" "$CARGO_TOML"
        else
            sed -i "s/members = \[/members = [\"{{YEAR}}\/$DAY_DIR\", /" "$CARGO_TOML"
        fi
        echo "Added $PKG_NAME to workspace"
    fi

    echo ""
    echo "Successfully created $PKG_NAME at $DAY_DIR/"
    echo ""
    echo "Next steps:"
    echo "  1. Add your puzzle input to {{day}}/input"
    echo "  2. Add sample input to {{day}}/sample_1"
    echo "  3. Implement your solution in {{day}}/src/main.rs"
    echo "  4. Test with: just test {{day}}"
    echo "  5. Run with: just run {{day}}"

# Clean build artifacts
[group('clean')]
clean:
    cargo clean

# Update Rust dependencies
[group('update')]
update:
    @echo "Updating Rust dependencies..."
    cargo update
    @echo ""
    @echo "Updated Cargo.lock"

# Update Rust toolchain
[group('update')]
update-toolchain:
    @echo "Updating Rust toolchain..."
    rustup update
    @rustc --version
    @cargo --version

# Install Rust toolchain if not present
[group('setup')]
install-toolchain:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "Checking Rust toolchain installation..."
    echo ""

    # Install rustup if not present
    if ! command -v rustup &> /dev/null; then
        echo "Installing Rust via rustup..."
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
        echo "✓ Rust installed"
    else
        echo "✓ rustup already installed"
    fi

    # Install cargo-nextest if not present
    if ! command -v cargo-nextest &> /dev/null; then
        echo "Installing cargo-nextest..."
        cargo install cargo-nextest --locked
        echo "✓ cargo-nextest installed"
    else
        echo "✓ cargo-nextest already installed"
    fi

    echo ""
    echo "Rust toolchain setup complete!"
    echo ""
    echo "Versions:"
    echo "  rustc:  $(rustc --version)"
    echo "  cargo:  $(cargo --version)"
    echo "  nextest: $(cargo nextest --version | head -n1)"
    echo ""
    echo "To use Rust in this shell, run: source \$HOME/.cargo/env"
